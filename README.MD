# üè≠ C√©lula 5 ‚Äì Contagem e Rastreamento de Itens na Linha  
## Trabalho 02 ‚Äì Conectividade MQTT  
### Curso de Sistemas de Informa√ß√£o ‚Äì UNIDAVI  
**Aluno:** Caio Augusto Ledra  
**Professor:** Esp. Ademar Perfoll Junior  
**Disciplina:** Internet das Coisas (IoT)  

---

## üìò Descri√ß√£o do Projeto

Este projeto implementa a **C√©lula 5** do laborat√≥rio de IoT, respons√°vel pela **contagem e rastreamento de itens** em uma linha de produ√ß√£o.  
Na segunda etapa do trabalho, o sistema foi integrado √† **Internet das Coisas (IoT)** por meio do **protocolo MQTT**, publicando telemetria e status em um **broker MQTT**, com suporte a **LWT (Last Will & Testament)** e **reconex√£o autom√°tica**.  

O sistema baseia-se em um **Arduino Mega + ESP8266 WiFi Shield**, sensor **HC-SR04**, **LCD 16x2**, **LEDs**, **buzzer** e **bot√µes** (reset e pausa).  
A telemetria √© publicada periodicamente e o dispositivo responde a comandos MQTT de consulta de status.

---

## üß† Objetivos do Trabalho

- Conectar o dispositivo √† rede Wi-Fi e ao broker MQTT.  
- Publicar o **estado do dispositivo** (`online/offline`).  
- Enviar **telemetria peri√≥dica** e **eventos pontuais**.  
- Assinar comandos MQTT (ex.: `get_status`).  
- Implementar **reconex√£o autom√°tica** em caso de falha.  
- Garantir **compatibilidade com o padr√£o de t√≥picos definido** pela disciplina.

---

## üåê Estrutura de T√≥picos MQTT

Formato padronizado:

`iot/riodosul/si/BSN22025T26F8/cell/5/device/c5-caio-ledra/`

 ```bash
 | Tipo | T√≥pico | Dire√ß√£o | QoS | Retained | Descri√ß√£o |
 |------|---------|----------|------|-----------|------------|
 | Estado | `.../state` | Publica√ß√£o | 0 | ‚úÖ | Indica se o dispositivo est√° online/offline |
 | Telemetria | `.../telemetry` | Publica√ß√£o | 1 | ‚ùå | Envia dados de sensores e status |
 | Evento | `.../event` | Publica√ß√£o | 1 | ‚ùå | Publica eventos como ‚Äúfalha_cr√≠tica‚Äù |
 | Comando | `.../cmd` | Assinatura | 1 | ‚ùå | Recebe comandos em JSON |
 | Config | `.../config` | Pub/Sub | 1 | ‚úÖ | Envia e recebe thresholds de opera√ß√£o |
 ```

---

## üì¶ Estrutura do Payload JSON

### Telemetria (`telemetry`)
 ```json
 {
   "ts": 1739812345,
   "cellId": 5,
   "devId": "c5-caio-ledra",
   "metrics": {
     "count": 58,
     "velocity": 12
   },
   "status": "normal",
   "units": {
     "count": "itens",
     "velocity": "itens/min"
   },
   "thresholds": {
     "normal": "<=10s",
     "atencao": "<=20s",
     "critico": ">20s"
   }
 }
 ```

### Evento (`event`)
 ```json
 {
   "ts": 1739812401,
   "type": "falha_critica",
   "info": "20s sem item detectado"
 }
 ```

### Comando (`cmd`)
 ```json
 {
   "action": "get_status"
 }
 ```

---

## ‚öôÔ∏è Funcionalidades Implementadas

‚úÖ Conex√£o Wi-Fi autom√°tica (SSID e senha em `secrets.h`)  
‚úÖ Conex√£o MQTT com LWT (offline retained)  
‚úÖ Reconex√£o autom√°tica Wi-Fi + MQTT  
‚úÖ Publica√ß√£o peri√≥dica (3s) e on-change (mudan√ßa de status)  
‚úÖ Leitura do sensor ultrass√¥nico HC-SR04  
‚úÖ C√°lculo de velocidade (itens/minuto)  
‚úÖ Detec√ß√£o de falhas normal e cr√≠tica  
‚úÖ Eventos publicados em MQTT (`event`)  
‚úÖ Assinatura de comandos (`get_status`)  
‚úÖ Exibi√ß√£o de dados no LCD 16x2  

---

## üìã Tabela de Componentes

| Componente                       | Quantidade | Valor / Modelo | Fun√ß√£o no Circuito                 |
|----------------------------------|-----------:|----------------|------------------------------------|
| Arduino MEGA 2560                | 1          | -              | Unidade comunica√ß√£o USB            |
| Shield ESP8266                   | 1          | -              | Unidade de controle e MQTT         |
| Sensor ultrass√¥nico HC-SR04      | 1          | -              | Medi√ß√£o de dist√¢ncia / detec√ß√£o de itens |
| Display LCD 16x2 (HD44780)       | 1          | -              | Exibi√ß√£o de dados e mensagens      |
| LED Verde                        | 1          | 220 Œ© resistor | Indica√ß√£o de funcionamento normal  |
| LED Vermelho                     | 1          | 220 Œ© resistor | Indica√ß√£o de falha                 |
| Buzzer                           | 1          | -              | Alerta sonoro                      |
| Bot√£o Reset                      | 1          | -              | Reinicializa√ß√£o do contador        |
| Bot√£o Pausar                     | 1          | -              | Pausa dos alertas de falha         |
| Protoboard                       | 2          | -              | Conex√£o dos componentes            |
| Jumpers                          | ~20        | -              | -                                  |

---

## üîå Mapa de Pinos

| Pino ESP8266 (NodeMCU) | GPIO    | Componente Conectado           | Fun√ß√£o                                  |
|------------------------|---------|--------------------------------|-----------------------------------------|
| D5                     | GPIO14  | Trigger (HC-SR04)              | Emiss√£o do pulso ultrass√¥nico           |
| D6                     | GPIO12  | Echo (HC-SR04)                 | Recep√ß√£o do eco                         |
| D1                     | GPIO5   | LED Verde                      | Indica√ß√£o de opera√ß√£o normal            |
| D7                     | GPIO13  | LED Vermelho                   | Indica√ß√£o de falha                      |
| D0                     | GPIO16  | Buzzer                         | Alerta sonoro                           |
| D3                     | GPIO0   | Bot√£o Reset                    | Reinicializa√ß√£o do contador             |
| D4                     | GPIO2   | Bot√£o Pausar                   | Pausa dos alertas                       |
| TX / RX                | -       | Serial ‚Üí Arduino Mega (TX1/RX1)| Comunica√ß√£o entre placas                |
| 5V / GND               | -       | Protoboard / Sensores / LEDs   | Alimenta√ß√£o e refer√™ncia comum          |


---

## üß∞ Bibliotecas Utilizadas

- `ESP8266WiFi.h`
- `PubSubClient.h`
- `ArduinoJson.h`
- `EEPROM.h`
- `LiquidCrystal.h`

---


## üß™ Testes Realizados

| Teste | Resultado Esperado | Status |
|--------|-------------------|--------|
| Publica√ß√£o state=online ao conectar | OK | ‚úÖ |
| Publica√ß√£o state=offline via LWT | OK | ‚úÖ |
| Telemetria peri√≥dica (3s) | OK | ‚úÖ |
| Mudan√ßa de status entre normal/aten√ß√£o/cr√≠tico | OK | ‚úÖ |
| Resposta a get_status | OK | ‚úÖ |
| Reconex√£o Wi-Fi + MQTT autom√°tica | OK | ‚úÖ |
| Eventos de falha publicados | OK | ‚úÖ |

---

## üí¨ Exemplos de Comandos

Enviar comando MQTT com `mosquitto_pub`:

 ```bash
 mosquitto_pub -h broker.hivemq.com \
 -t "iot/riodosul/si/BSN22025T26F8/cell/5/device/c5-caio-ledra/cmd" \
 -m '{"action":"get_status"}'
 ```

## üß∑ Refer√™ncias

- **ARDUINO.** Arduino Documentation. Dispon√≠vel em: <https:docs.arduino.cc/>  
- **ELEGOO.** HC-SR04 Ultrasonic Sensor Datasheet. 2024.  
- **HITACHI.** LCD Controller/Driver HD44780 Datasheet. 2023.  
- **MQTT.** MQTT Essentials - HiveMQ. Dispon√≠vel em: <https:www.hivemq.com/mqtt/>  
- **UNIDAVI.** Normas para Elabora√ß√£o de Trabalhos Acad√™micos. 2023.  

## Desenvolvido por @ledracaio
