# ğŸ­ CÃ©lula 5 â€“ Contagem e Rastreamento de Itens na Linha  
## Trabalho 02 â€“ Conectividade MQTT  
### Curso de Sistemas de InformaÃ§Ã£o â€“ UNIDAVI  
**Aluno:** Caio Augusto Ledra  
**Professor:** Esp. Ademar Perfoll Junior  
**Disciplina:** Internet das Coisas (IoT)  

---

## ğŸ“˜ DescriÃ§Ã£o do Projeto

Este projeto implementa a **CÃ©lula 5** do laboratÃ³rio de IoT, responsÃ¡vel pela **contagem e rastreamento de itens** em uma linha de produÃ§Ã£o.  
Na segunda etapa do trabalho, o sistema foi integrado Ã  **Internet das Coisas (IoT)** por meio do **protocolo MQTT**, publicando telemetria e status em um **broker MQTT**, com suporte a **LWT (Last Will & Testament)** e **reconexÃ£o automÃ¡tica**.  

O sistema baseia-se em um **Arduino Mega + ESP8266 WiFi Shield**, sensor **HC-SR04**, **LCD 16x2**, **LEDs**, **buzzer** e **botÃµes** (reset e pausa).  
A telemetria Ã© publicada periodicamente e o dispositivo responde a comandos MQTT de consulta de status.

---

## ğŸ§  Objetivos do Trabalho

- Conectar o dispositivo Ã  rede Wi-Fi e ao broker MQTT.  
- Publicar o **estado do dispositivo** (`online/offline`).  
- Enviar **telemetria periÃ³dica** e **eventos pontuais**.  
- Assinar comandos MQTT (ex.: `get_status`).  
- Implementar **reconexÃ£o automÃ¡tica** em caso de falha.  
- Garantir **compatibilidade com o padrÃ£o de tÃ³picos definido** pela disciplina.

---

## ğŸŒ Estrutura de TÃ³picos MQTT

Formato padronizado:

`iot/riodosul/si/BSN22025T26F8/cell/5/device/c5-caio-ledra/`

 ```bash
 | Tipo | TÃ³pico | DireÃ§Ã£o | QoS | Retained | DescriÃ§Ã£o |
 |------|---------|----------|------|-----------|------------|
 | Estado | `.../state` | PublicaÃ§Ã£o | 0 | âœ… | Indica se o dispositivo estÃ¡ online/offline |
 | Telemetria | `.../telemetry` | PublicaÃ§Ã£o | 1 | âŒ | Envia dados de sensores e status |
 | Evento | `.../event` | PublicaÃ§Ã£o | 1 | âŒ | Publica eventos como â€œfalha_crÃ­ticaâ€ |
 | Comando | `.../cmd` | Assinatura | 1 | âŒ | Recebe comandos em JSON |
 | Config | `.../config` | Pub/Sub | 1 | âœ… | Envia e recebe thresholds de operaÃ§Ã£o |
 ```

---

## ğŸ“¦ Estrutura do Payload JSON

### Telemetria (`telemetry`)
 ```json
 {
   "ts": 1739812345,
   "cellId": 5,
   "devId": "c5-caio-ledra",
   "metrics": {
     "count": 58,
     "velocity": 12
   },
   "status": "normal",
   "units": {
     "count": "itens",
     "velocity": "itens/min"
   },
   "thresholds": {
     "normal": "<=10s",
     "atencao": "<=20s",
     "critico": ">20s"
   }
 }
 ```

### Evento (`event`)
 ```json
 {
   "ts": 1739812401,
   "type": "falha_critica",
   "info": "20s sem item detectado"
 }
 ```

### Comando (`cmd`)
 ```json
 {
   "action": "get_status"
 }
 ```

---

## âš™ï¸ Funcionalidades Implementadas

âœ… ConexÃ£o Wi-Fi automÃ¡tica (SSID e senha em `secrets.h`)  
âœ… ConexÃ£o MQTT com LWT (offline retained)  
âœ… ReconexÃ£o automÃ¡tica Wi-Fi + MQTT  
âœ… PublicaÃ§Ã£o periÃ³dica (3s) e on-change (mudanÃ§a de status)  
âœ… Leitura do sensor ultrassÃ´nico HC-SR04  
âœ… CÃ¡lculo de velocidade (itens/minuto)  
âœ… DetecÃ§Ã£o de falhas normal e crÃ­tica  
âœ… Eventos publicados em MQTT (`event`)  
âœ… Assinatura de comandos (`get_status`)  
âœ… ExibiÃ§Ã£o de dados no LCD 16x2  

---

## ğŸ“‹ Tabela de Componentes

| Componente | Quant. | Valor | FunÃ§Ã£o |
|-------------|--------|--------|--------|
| Arduino Mega 2560 | 1 | â€” | Microcontrolador principal |
| MÃ³dulo WiFi ESP8266 | 1 | â€” | Conectividade MQTT |
| Sensor ultrassÃ´nico HC-SR04 | 1 | â€” | MediÃ§Ã£o de distÃ¢ncia |
| Display LCD 16x2 | 1 | â€” | ExibiÃ§Ã£o de contagem e status |
| LED Verde | 1 | â€” | IndicaÃ§Ã£o de item detectado |
| LED Vermelho | 1 | â€” | IndicaÃ§Ã£o de falha |
| Buzzer | 1 | â€” | Alerta sonoro |
| BotÃ£o Reset | 1 | â€” | Reinicia contagem |
| BotÃ£o Pausa | 1 | â€” | Pausa alarmes temporariamente |
| Resistores | 4 | 220Î© | LimitaÃ§Ã£o de corrente |
| Protoboard | 2 | â€” | ConexÃ£o do circuito |
| Jumpers | ~20 | â€” | ConexÃ£o do circuito |

---

## ğŸ”Œ Mapa de Pinos (Arduino Mega)

| Componente | Pino | FunÃ§Ã£o |
|-------------|------|--------|
| HC-SR04 TRIG | D5 | SaÃ­da de trigger |
| HC-SR04 ECHO | D6 | Entrada de eco |
| LCD RS | 48 | Controle RS |
| LCD E | 46 | Enable |
| LCD D4â€“D7 | 45, 43, 51, 53 | Dados |
| LED Verde | 8 | Sinal de item detectado |
| LED Vermelho | 9 | Alerta de falha |
| Buzzer | 10 | Alerta sonoro |
| BotÃ£o Reset | 11 | Reset contador |
| BotÃ£o Pausa | 12 | Pausar alerta |

---

## ğŸ§° Bibliotecas Utilizadas

- `ESP8266WiFi.h`
- `PubSubClient.h`
- `ArduinoJson.h`
- `EEPROM.h`
- `LiquidCrystal.h`

---


## ğŸ§ª Testes Realizados

| Teste | Resultado Esperado | Status |
|--------|-------------------|--------|
| PublicaÃ§Ã£o state=online ao conectar | OK | âœ… |
| PublicaÃ§Ã£o state=offline via LWT | OK | âœ… |
| Telemetria periÃ³dica (3s) | OK | âœ… |
| MudanÃ§a de status entre normal/atenÃ§Ã£o/crÃ­tico | OK | âœ… |
| Resposta a get_status | OK | âœ… |
| ReconexÃ£o Wi-Fi + MQTT automÃ¡tica | OK | âœ… |
| Eventos de falha publicados | OK | âœ… |

---

## ğŸ’¬ Exemplos de Comandos

Enviar comando MQTT com `mosquitto_pub`:

 ```bash
 mosquitto_pub -h broker.hivemq.com \
 -t "iot/riodosul/si/BSN22025T26F8/cell/5/device/c5-caio-ledra/cmd" \
 -m '{"action":"get_status"}'
 ```

## ğŸ§· ReferÃªncias

- **ARDUINO.** Arduino Documentation. DisponÃ­vel em: <https:docs.arduino.cc/>  
- **ELEGOO.** HC-SR04 Ultrasonic Sensor Datasheet. 2024.  
- **HITACHI.** LCD Controller/Driver HD44780 Datasheet. 2023.  
- **MQTT.** MQTT Essentials - HiveMQ. DisponÃ­vel em: <https:www.hivemq.com/mqtt/>  
- **UNIDAVI.** Normas para ElaboraÃ§Ã£o de Trabalhos AcadÃªmicos. 2023.  

## Desenvolvido por @ledracaio
